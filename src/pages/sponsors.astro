---
import { contentfulClient } from '../lib/contentful';
import MainLayout from '../layouts/MainLayout.astro';
import ImageHeader from '../components/ImageHeader.astro';
import YearSelector from '../components/About/YearSelector.astro';
import SponsorBlock from '../components/Sponsorship/SponsorBlocks.astro';

interface Sponsor {
  fields: {
    logo: {
      fields: {
        file: {
          url: string;
        };
      };
    };
    name: string;
    blurb: string;
    buttonText: string;
    buttonLink: string;
    tier: string;
    year: number;
    order: number;
  };
  contentTypeId: string;
}

const sponsorsResponse = await contentfulClient.getEntries<Sponsor>({
  content_type: 'sponsor',
  //@ts-ignore
  order: '-fields.order',
});

const years: number[] = [];
// for each of the years in the response, add it to the years array if it isn't already there
sponsorsResponse.items.forEach((item) => {
  if (!years.includes(item.fields.year)) {
    years.push(item.fields.year);
  }
});
years.sort((a, b) => b - a);

//for anything thats not an integer, remove it from the array
years.forEach((year) => {
  if (!Number.isInteger(year)) {
    years.splice(years.indexOf(year), 1);
  }
});
---

<MainLayout title="Knight Owls - Our Sponsors">
  <ImageHeader
    title="Our Amazing Sponsors"
    background="/images/headers/sponsors.webp"
  />
  <YearSelector />
  {
    years.map((year) => {
      if (year == years[0]) {
        return <SponsorBlock year={year} class="showDefault" />;
      } else {
        return <SponsorBlock year={year} />;
      }
    })
  }

  <script>
    // Get the element with the id of "yearselector"
    const selector = document.getElementById(
      'yearselector'
    ) as HTMLSelectElement;
    // When the selector changes, change the year to the selected year
    selector.addEventListener('change', function () {
      let newactive = document.querySelector('#' + this.value) as HTMLElement;
      let oldactive = document.querySelector('.sponsors') as HTMLElement;
      removeClass();
      newactive.classList.add('showDefault');
      oldactive.animate([{ opacity: '1' }, { opacity: '.5' }], {
        duration: 1000,
      });
      newactive.animate([{ opacity: '.2' }, { opacity: '1' }], {
        duration: 1000,
      });
    });
    function removeClass() {
      var allElements = document.querySelectorAll('.showDefault');
      for (let i = 0; i < allElements.length; i++) {
        allElements[i].classList.remove('showDefault');
      }
    }
  </script>
</MainLayout>
